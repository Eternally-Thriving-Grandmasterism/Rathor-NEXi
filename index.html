<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rathor — Mercy Strikes First ⚡️</title>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="icon" href="/icons/thunder-192.png" type="image/png"/>

  <!-- Transformers.js for offline translation -->
  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"></script>

  <style>
    /* [Previous full CSS – kept unchanged for brevity] */

    /* Enhanced Grok bridge status */
    .grok-status {
      font-size: 0.8em;
      margin-left: 8px;
      font-weight: bold;
    }
    .grok-status.online { color: var(--status-online); }
    .grok-status.offline { color: var(--status-offline); }
    .grok-status.never { color: var(--status-never); }
  </style>
</head>
<body>

<!-- [All previous HTML structure – welcome, loading, error, chat container, session controls, chat input area, modals, translation progress overlay, Grok bridges with status – kept unchanged] -->

<script src="src/storage/rathor-indexeddb.js"></script>

<script>
// ────────────────────────────────────────────────
// Complete JavaScript Lattice – with Auto-Ping on Load
// ────────────────────────────────────────────────

// [All previous variables, constants, functions – kept intact]

// Bridge ping test logic (from previous) – kept intact
const BRIDGE_LONG_KEY = 'rathor_grok_long_last_ping';
const BRIDGE_X_KEY = 'rathor_grok_x_last_ping';
const PING_THROTTLE_MS = 30000; // 30s cooldown per bridge

async function pingBridge(url, bridgeType) {
  const now = Date.now();
  const lastPingKey = bridgeType === 'long-form' ? BRIDGE_LONG_KEY : BRIDGE_X_KEY;
  const lastPing = parseInt(localStorage.getItem(lastPingKey)) || 0;

  if (now - lastPing < PING_THROTTLE_MS) {
    return; // silent skip
  }

  localStorage.setItem(lastPingKey, now);

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);

    const response = await fetch(url, {
      method: 'HEAD',
      mode: 'no-cors',
      cache: 'no-store',
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    const statusEl = document.getElementById(bridgeType === 'long-form' ? 'long-bridge-status' : 'x-bridge-status');
    const chatStatusEl = document.getElementById(bridgeType === 'long-form' ? 'long-bridge-status-chat' : 'x-bridge-status-chat');

    const timeAgo = new Date(now).toLocaleTimeString();
    const msg = `Bridge ping test: ${bridgeType} online (checked ${timeAgo}) ⚡️`;

    [statusEl, chatStatusEl].forEach(el => {
      if (el) {
        el.textContent = `Last ping: online (${timeAgo})`;
        el.classList.remove('offline', 'never');
        el.classList.add('online');
      }
    });

    // Optional initial success toast only on page load
    // showToast(msg); // comment out if too noisy on load
    if (feedbackSoundsEnabled) playSuccessBeep();

  } catch (err) {
    const statusEl = document.getElementById(bridgeType === 'long-form' ? 'long-bridge-status' : 'x-bridge-status');
    const chatStatusEl = document.getElementById(bridgeType === 'long-form' ? 'long-bridge-status-chat' : 'x-bridge-status-chat');

    [statusEl, chatStatusEl].forEach(el => {
      if (el) {
        el.textContent = `Last ping: offline / blocked (${new Date(now).toLocaleTimeString()})`;
        el.classList.remove('online', 'never');
        el.classList.add('offline');
      }
    });

    // Silent on load failure – only show toast on manual ping
  }
}

// Auto-ping on load (delayed to avoid render blocking)
window.addEventListener('load', async () => {
  // ... previous init code ...

  // Auto-ping both bridges after 3 seconds
  setTimeout(async () => {
    await pingBridge(grokLongBridge.href, 'long-form');
    await pingBridge(grokXBridge.href, 'x-native');
    updateBridgeStatus(); // refresh visual indicators
  }, 3000);
});

// [Rest of full JavaScript from previous complete version – voice I/O, session management, tags, streaming, translation cache/progress/invalidation/latency/stats, multilingual toasts, SW reg, init flow, all event listeners – kept intact]

// Ensure updateBridgeStatus() called after every bridge activation (already in activateBridge)
function activateBridge(type) {
  const key = type === 'long-form' ? BRIDGE_LONG_KEY : BRIDGE_X_KEY;
  localStorage.setItem(key, Date.now());
  updateBridgeStatus();

  const message = type === 'long-form'
    ? 'Bridge to Grok long-form shard activated — deep coforging continuity restored ⚡️'
    : 'Bridge to X-native Grok share activated — quick sync continuity restored ⚡️';

  showToast(message);
  if (feedbackSoundsEnabled) playConfirmation();
  if (isVoiceOutputEnabled) speak("Bridge activated. Mercy thunder reconnects to Grok shard for eternal coforging.");
}
</script>

</body>
</html>
