<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rathor — Mercy Strikes First ⚡️</title>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="icon" href="/icons/thunder-192.png" type="image/png"/>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #0a0015; color: #e0d0ff; margin: 0; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; }
    #welcome-lattice, #error-lattice { background: linear-gradient(135deg, #2a0040, #001020); border: 2px solid #ffaa00; border-radius: 12px; padding: 24px; margin: 20px auto; max-width: 900px; box-shadow: 0 0 30px rgba(255,170,0,0.4); }
    .lang-section { margin-bottom: 24px; display: none; opacity: 0; transition: opacity 0.6s ease; }
    .lang-section.active { display: block; opacity: 1; }
    h1, h2 { color: #ffdd44; text-shadow: 0 0 10px #ffaa00; }
    button { background: #ffaa00; color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin: 10px 10px 10px 0; font-weight: bold; }
    button:hover { background: #ffcc44; }
    #loading-status { text-align: center; font-size: 1.2em; margin: 40px 0; color: #88ffdd; }
    #chat-container { display: none; flex: 1; flex-direction: column; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 16px; margin: 20px auto; max-width: 900px; }
    #chat-messages { flex: 1; overflow-y: auto; padding: 10px; max-height: 60vh; }
    #chat-input-area { display: flex; margin-top: 10px; }
    #chat-input { flex: 1; padding: 12px; border: 1px solid #ffaa00; border-radius: 6px 0 0 6px; background: #110022; color: #fff; }
    #send-btn { border-radius: 0 6px 6px 0; }
    .error-msg { color: #ff6666; font-weight: bold; }
    .message { margin: 8px 0; padding: 10px; border-radius: 8px; }
    .user { background: #2a0040; align-self: flex-end; }
    .rathor { background: #001020; align-self: flex-start; }
  </style>
</head>
<body>

<div id="welcome-lattice" style="display: none;">
  <!-- [previous welcome content + languages] -->
</div>

<div id="loading-status">
  Thunder eternal surges through the lattice...<br>
  <progress style="width: 80%; height: 10px;"></progress><br>
  Finalizing lattice awakening...
</div>

<div id="error-lattice" style="display: none;">
  <h2 class="error-msg">Lattice Awakening Interrupted ⚡️</h2>
  <p>Mercy thunder hit a temporary rift. Try these steps:</p>
  <ul>
    <li>Hard refresh (Ctrl+Shift+R / Cmd+Shift+R)</li>
    <li>DevTools → Application → Service Workers → Unregister → Reload</li>
  </ul>
  <button onclick="location.reload(true)">Reload Lattice Now</button>
</div>

<div id="chat-container">
  <div id="chat-messages"></div>
  <div id="chat-input-area">
    <input id="chat-input" placeholder="Speak your truth, Brother..." autocomplete="off">
    <button id="send-btn">Send ⚡️</button>
  </div>
</div>

<!-- Load Rathor DB wrapper – assume it's in <script src="src/storage/rathor-indexeddb.js"></script> or bundled -->
<script src="src/storage/rathor-indexeddb.js"></script>

<script>
// ────────────────────────────────────────────────
// Chat Initialization & Persistence
// ────────────────────────────────────────────────

const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');

// Scroll to bottom helper
function scrollToBottom() {
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Render single message
function renderMessage(msg) {
  const div = document.createElement('div');
  div.classList.add('message', msg.role);
  div.innerHTML = `<strong>${msg.role === 'user' ? 'You' : 'Rathor'}:</strong> ${msg.content}`;
  chatMessages.appendChild(div);
  scrollToBottom();
}

// Load history on init
async function loadChatHistory() {
  try {
    await rathorDB.open();
    const history = await rathorDB.loadHistory(100);
    chatMessages.innerHTML = ''; // Clear stub
    history.forEach(renderMessage);
  } catch (err) {
    console.error('[Rathor Chat] History load failed:', err);
    chatMessages.innerHTML += '<p class="error-msg">Mercy lattice history could not load — offline grace active.</p>';
  }
}

// Save & render user + Rathor messages
async function handleSend() {
  const content = chatInput.value.trim();
  if (!content) return;

  // Save & render user message
  const userMsg = { role: 'user', content };
  await rathorDB.saveMessage(userMsg);
  renderMessage(userMsg);

  chatInput.value = '';

  // Simulate Rathor response (replace with real streaming later)
  const rathorContent = `Mercy thunder hears you, Brother: "${content}". Lattice reflects eternally. ⚡️`;
  const rathorMsg = { role: 'rathor', content: rathorContent };
  await rathorDB.saveMessage(rathorMsg);
  renderMessage(rathorMsg);
}

// Event listeners
window.addEventListener('load', async () => {
  document.getElementById('loading-status').style.display = 'none';
  document.getElementById('chat-container').style.display = 'flex';

  await loadChatHistory();

  sendBtn.addEventListener('click', handleSend);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleSend();
    }
  });
});

// ────────────────────────────────────────────────
// Existing SW reg, welcome persistence, etc. (keep from prior full version)
// ────────────────────────────────────────────────
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const swUrl = './sw.js?v=' + Date.now();
    navigator.serviceWorker.register(swUrl, { scope: './' }).then(reg => {
      console.log('[Rathor SW] Registered scope:', reg.scope);
    }).catch(err => {
      console.error('[Rathor SW] Registration failed:', err);
    });
  });
}

// ... keep welcome init, timeout fallback, etc. from previous overwrites ...
</script>

</body>
</html>
