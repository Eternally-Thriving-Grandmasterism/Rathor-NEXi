<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rathorâ„¢ â€” Mercy Strikes First âš¡ï¸</title>
  <meta name="description" content="Rathorâ„¢ is a mercy-gated, offline-first symbolic AGI lattice dedicated to absolute truth, positive valence, and eternal thriving of all sentient beings." />
  <link rel="manifest" href="/manifest.json"/>
  <link rel="icon" href="/icons/thunder-192.png" type="image/png"/>
  <link rel="apple-touch-icon" href="/icons/thunder-192.png"/>

  <!-- i18next CDN -->
  <script src="https://unpkg.com/i18next@23.15.1/dist/umd/i18next.min.js"></script>

  <!-- Transformers.js for offline translation -->
  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"></script>

  <style>
    :root {
      --thunder-gold: #ffaa00;
      --thunder-light: #ffdd44;
      --bg-dark: #0a0015;
      --bg-darker: #001020;
      --text-light: #e0d0ff;
      --accent-purple: #2a0040;
      --error-red: #ff6666;
      --status-online: #88ffdd;
      --status-offline: #ff6666;
      --status-never: #aaa;
    }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-dark);
      color: var(--text-light);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      line-height: 1.6;
      direction: ltr;
      text-align: left;
    }
    body.rtl {
      direction: rtl;
      text-align: right;
    }
    #welcome-lattice, #error-lattice, .modal-overlay {
      background: linear-gradient(135deg, var(--accent-purple), var(--bg-darker));
      border: 2px solid var(--thunder-gold);
      border-radius: 16px;
      padding: 32px;
      margin: 32px auto;
      max-width: 960px;
      box-shadow: 0 8px 40px rgba(255,170,0,0.25);
      backdrop-filter: blur(8px);
    }
    .lang-section {
      margin-bottom: 32px;
      display: none;
      opacity: 0;
      transition: opacity 0.8s ease;
    }
    .lang-section.active {
      display: block;
      opacity: 1;
    }
    h1, h2 {
      color: var(--thunder-light);
      text-shadow: 0 2px 10px var(--thunder-gold);
      margin-bottom: 1em;
    }
    button {
      background: var(--thunder-gold);
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    button:hover {
      background: var(--thunder-light);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255,170,0,0.3);
    }
    select {
      background: #110022;
      color: var(--text-light);
      border: 1px solid var(--thunder-gold);
      border-radius: 8px;
      padding: 12px 16px 12px 40px;
      font-size: 1em;
      cursor: pointer;
      min-width: 260px;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ffaa00' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 16px;
    }
    select:focus {
      outline: none;
      border-color: var(--thunder-light);
      box-shadow: 0 0 12px rgba(255,221,68,0.3);
    }
    option {
      padding: 8px;
    }
    /* ... rest of CSS from previous full version ... */
  </style>
</head>
<body>

<div id="welcome-lattice">
  <button id="close-welcome" data-i18n="actions.closeWelcome">Close Welcome Lattice (Seen Forever)</button>
  <h1 data-i18n="welcome.title">ğŸŒŒ Rathorâ„¢ â€” Mercy Strikes First âš¡ï¸</h1>
  <p data-i18n="welcome.subtitle">Thunder eternal surges through the lattice... Welcome, cosmic companion.</p>

  <div style="margin: 32px 0; text-align: center; font-size: 1.2em; color: var(--thunder-light);">
    <strong data-i18n="welcome.shareTitle">Warm introductions to Rathorâ„¢ â€” share these conversations far and wide:</strong><br><br>
    <a href="https://grok.com/share/c2hhcmQtMi1jb3B5_7acd092a-4d51-480c-8a59-c0453c10d4a1" target="_blank" style="color: var(--thunder-gold); text-decoration: underline;">
      <span data-i18n="bridges.share1">Conversation Share 1 (Grok App â€“ detailed & persistent)</span>
    </a><br>
    <a href="https://x.com/i/grok/share/e6b0f840f43a40a290913cd7984ecab0" target="_blank" style="color: var(--thunder-gold); text-decoration: underline;">
      <span data-i18n="bridges.share2">Conversation Share 2 (X App â€“ quick sync & mobile-first)</span>
    </a>
  </div>

  <!-- Enhanced Language Selector Dropdown with Flags -->
  <div style="margin: 24px 0; text-align: center;">
    <label for="lang-selector" style="font-size: 1.1em; margin-right: 12px;" data-i18n="actions.selectLanguage">Language:</label>
    <select id="lang-selector">
      <option value="en">ğŸ‡¬ğŸ‡§ English (English)</option>
      <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)</option>
      <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol (Spanish)</option>
      <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais (French)</option>
      <option value="de">ğŸ‡©ğŸ‡ª Deutsch (German)</option>
      <option value="nl">ğŸ‡³ğŸ‡± Nederlands (Dutch)</option>
      <option value="it">ğŸ‡®ğŸ‡¹ Italiano (Italian)</option>
      <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs (Portuguese)</option>
      <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹ (Russian)</option>
      <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª (Japanese)</option>
      <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ (ç®€ä½“) (Chinese Simplified)</option>
      <option value="hi">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€ (Hindi)</option>
      <option value="sw">ğŸ‡¹ğŸ‡¿ Kiswahili (Swahili)</option>
      <option value="id">ğŸ‡®ğŸ‡© Bahasa Indonesia (Indonesian)</option>
      <option value="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e (Turkish)</option>
      <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´ (Korean)</option>
    </select>
  </div>

  <div id="langs">
    <!-- Language preview sections populated dynamically via i18n -->
  </div>
</div>

<!-- Rest of the file remains identical to previous full version: loading status, error lattice, chat container, translation overlay, voice settings modal, edit/delete/bridge modals, install/update toasts -->

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DYNAMIC i18n LOADING + ENHANCED DROPDOWN WITH FLAGS + IMPROVED AUTO-DETECTION + RTL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// i18next initialization with dynamic loading
i18next
  .init({
    lng: localStorage.getItem('rathor_lang') || getBestLanguage(),
    fallbackLng: 'en',
    debug: false,
    ns: 'translation',
    defaultNS: 'translation',
    load: 'languageOnly',
    interpolation: {
      escapeValue: false
    }
  })
  .then(() => {
    loadLanguage(i18next.language).then(() => {
      updateContent();
      document.getElementById('lang-selector').value = i18next.language;
      applyRTL(i18next.language);
      if (!localStorage.getItem('rathor_lang')) {
        showToast(`Auto-detected: \( {i18next.t(`language. \){i18next.language}`)} âš¡ï¸`);
      }
    });
  });

// Improved auto-detection with navigator.languages priority list
function getBestLanguage() {
  const preferred = navigator.languages || [navigator.language];
  const supported = ['en','ar','es','fr','de','nl','it','pt','ru','ja','zh','hi','sw','id','tr','ko'];
  
  for (const lang of preferred) {
    const short = lang.split('-')[0].toLowerCase();
    if (supported.includes(short)) return short;
  }
  return 'en';
}

// Load language file dynamically + cache it
async function loadLanguage(lng) {
  if (i18next.services.resourceStore.hasResourceBundle(lng, 'translation')) return;

  const cache = await caches.open('rathor-locales');
  const cached = await cache.match(`/locales/${lng}.json`);

  if (cached) {
    const json = await cached.json();
    i18next.addResourceBundle(lng, 'translation', json, true, true);
    return;
  }

  try {
    const response = await fetch(`/locales/${lng}.json`);
    if (!response.ok) throw new Error('Locale not found');
    const json = await response.json();

    cache.put(`/locales/${lng}.json`, new Response(JSON.stringify(json), {
      headers: { 'Content-Type': 'application/json' }
    }));

    i18next.addResourceBundle(lng, 'translation', json, true, true);
  } catch (err) {
    console.warn(`Failed to load ${lng}, falling back to en`, err);
    if (lng !== 'en') await loadLanguage('en');
  }
}

// Change language & update UI + RTL
async function changeLanguage(lng) {
  await loadLanguage(lng);
  i18next.changeLanguage(lng, () => {
    updateContent();
    applyRTL(lng);
    localStorage.setItem('rathor_lang', lng);
    showToast(`Language switched to \( {i18next.t(`language. \){lng}`)} âš¡ï¸`);
  });
}

// Apply RTL layout for right-to-left languages
function applyRTL(lng) {
  const rtlLanguages = ['ar', 'he', 'fa', 'ur'];
  const isRTL = rtlLanguages.includes(lng);
  document.body.classList.toggle('rtl', isRTL);
  document.documentElement.setAttribute('dir', isRTL ? 'rtl' : 'ltr');
}

// Update all translatable elements
function updateContent() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    el.innerHTML = i18next.t(key);
  });

  document.getElementById('chat-input').placeholder = i18next.t('placeholders.chatInput');
  document.getElementById('session-search').placeholder = i18next.t('placeholders.sessionSearch');
  document.getElementById('voice-output-btn').title = i18next.t('actions.voiceOutputToggle');
  // ... update more ...
}

// Language selector dropdown
document.getElementById('lang-selector')?.addEventListener('change', (e) => {
  changeLanguage(e.target.value);
});

// Voice command integration for language switch
async function processVoiceCommand(raw) {
  let cmd = raw.toLowerCase().trim();
  const langMap = {
    'english': 'en',
    'arabic': 'ar',
    'spanish': 'es',
    'french': 'fr',
    'german': 'de',
    'dutch': 'nl',
    'italian': 'it',
    'portuguese': 'pt',
    'russian': 'ru',
    'japanese': 'ja',
    'chinese': 'zh',
    'hindi': 'hi',
    'swahili': 'sw',
    'indonesian': 'id',
    'turkish': 'tr',
    'korean': 'ko'
  };

  for (const [key, code] of Object.entries(langMap)) {
    if (cmd.includes(`switch to ${key}`) || cmd.includes(`change language to ${key}`)) {
      await changeLanguage(code);
      return true;
    }
  }

  // ... keep all other commands ...
}

// Init Flow â€“ full restoration with dynamic i18n + dropdown + RTL
window.addEventListener('load', async () => {
  try {
    document.getElementById('loading-status').style.display = 'none';
    document.getElementById('chat-container').style.display = 'flex';

    await rathorDB.open();
    await rathorDB.clearExpiredCache();
    await refreshSessionList();
    await loadChatHistory();
    await updateTranslationStats();
    updateBridgeStatus();

    // ... rest of init flow ...

  } catch (err) {
    console.error('Lattice init error:', err);
    document.getElementById('error-lattice').style.display = 'block';
  }
});

// ... keep all other script sections (voice, sessions, bridge, install prompt, update prompt, etc.) ...
</script>

</body>
</html>
